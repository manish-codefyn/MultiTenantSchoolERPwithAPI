{% extends 'layouts/dashboard.html' %}
{% load i18n static %}

{% block title %}{% trans "Transport QR Attendance" %}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-2">{% trans "Transport QR Attendance" %}</h2>
        <p class="text-muted">{% trans "Scan student ID card QR code to mark transport attendance." %}</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body text-center p-5">
                <div class="mb-4">
                    <i class="bx bx-qr-scan display-1 text-primary"></i>
                </div>
                
                <h4 class="mb-4">{% trans "Scan QR Code" %}</h4>
                
                <div class="mb-4">
                    <label class="form-label fw-bold d-block mb-3">{% trans "Select Trip Type" %}</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="trip_type" id="trip_pickup" value="PICKUP" checked>
                        <label class="btn btn-outline-primary py-2" for="trip_pickup">
                            <i class="bx bx-home-alt me-2"></i>{% trans "Pickup" %}
                        </label>

                        <input type="radio" class="btn-check" name="trip_type" id="trip_drop" value="DROP">
                        <label class="btn btn-outline-primary py-2" for="trip_drop">
                            <i class="bx bx-log-out-circle me-2"></i>{% trans "Drop" %}
                        </label>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <input type="text" id="reg_no_input" class="form-control form-control-lg text-center rounded-pill" placeholder="{% trans 'Click here and scan...' %}" autofocus>
                </div>
                <p class="text-muted small">{% trans "Ensure the input field is focused before scanning." %}</p>
                
                <div id="status-message" class="alert d-none mt-3 rounded-4" role="alert"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card border-0 shadow-sm rounded-4" id="last-scanned-card" style="display: none;">
            <div class="card-header bg-success text-white rounded-top-4 py-3">
                <h5 class="mb-0 fw-bold">{% trans "Last Scanned" %}</h5>
            </div>
            <div class="card-body text-center p-4">
                <div class="mb-3">
                    <img id="student-photo" src="" alt="Student Photo" class="rounded-circle img-thumbnail shadow-sm" style="width: 120px; height: 120px; object-fit: cover;">
                </div>
                <h5 id="student-name" class="fw-bold mb-1"></h5>
                <p id="student-reg" class="text-muted mb-2"></p>
                <span id="trip-badge" class="badge bg-primary rounded-pill px-3"></span>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.getElementById('reg_no_input');
        const statusDiv = document.getElementById('status-message');
        const card = document.getElementById('last-scanned-card');
        const sName = document.getElementById('student-name');
        const sReg = document.getElementById('student-reg');
        const sBadge = document.getElementById('trip-badge');
        const sPhoto = document.getElementById('student-photo');
        
        let timeout = null;

        input.addEventListener('input', function(e) {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const regNo = input.value.trim();
                if (regNo.length > 0) {
                    processScan(regNo);
                }
            }, 500); 
        });
        
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(timeout);
                const regNo = input.value.trim();
                if (regNo.length > 0) {
                    processScan(regNo);
                }
            }
        });

        function processScan(regNo) {
            input.disabled = true;
            const tripType = document.querySelector('input[name="trip_type"]:checked').value;
            
            fetch('{% url "transportation:attendance_qr" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `reg_no=${encodeURIComponent(regNo)}&trip_type=${tripType}`
            })
            .then(response => response.json())
            .then(data => {
                input.value = '';
                input.disabled = false;
                input.focus();
                
                statusDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
                
                if (data.status === 'success') {
                    statusDiv.classList.add('alert-success');
                    statusDiv.innerHTML = `<i class="bx bx-check-circle me-2"></i> ${data.message}`;
                    
                    // Update side card
                    card.style.display = 'block';
                    sName.textContent = data.student.name;
                    sReg.textContent = data.student.reg_no;
                    sBadge.textContent = tripType;
                    if (data.student.photo_url) {
                         sPhoto.src = data.student.photo_url;
                    } else {
                         sPhoto.src = '{% static "assets/images/avatars/avatar-1.png" %}'; 
                    }
                    
                    playBeep(true);
                } else {
                    statusDiv.classList.add('alert-danger');
                    statusDiv.innerHTML = `<i class="bx bx-error-circle me-2"></i> ${data.message}`;
                    playBeep(false);
                }
            })
            .catch(error => {
                input.disabled = false;
                input.focus();
                statusDiv.classList.remove('d-none');
                statusDiv.classList.add('alert-danger');
                statusDiv.textContent = 'Network error occurred';
                console.error('Error:', error);
            });
        }

        function playBeep(success) {
            // Optional: You could use a sound file or Web Audio API
            console.log(success ? "Success beep" : "Error beep");
        }
    });
</script>
{% endblock %}
