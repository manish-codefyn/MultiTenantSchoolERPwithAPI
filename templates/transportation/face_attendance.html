{% extends 'layouts/dashboard.html' %}
{% load i18n static %}

{% block title %}{% trans "Transport Face Attendance" %}{% endblock %}

{% block extra_css %}
<style>
    .face-preview-container {
        background: #000;
        border-radius: 20px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        margin: 0 auto;
        max-width: 640px;
    }
    .face-preview {
        width: 100%;
        min-height: 400px;
        object-fit: cover;
    }
    .face-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }
    .face-guide-box {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 250px;
        height: 320px;
        border: 2px dashed rgba(255,255,255,0.6);
        border-radius: 125px;
    }
    .scan-animation {
        position: absolute;
        top: 20%;
        left: 20%;
        right: 20%;
        height: 2px;
        background: rgba(99, 102, 241, 0.8);
        box-shadow: 0 0 15px rgba(99, 102, 241, 1);
        animation: scanMove 3s infinite linear;
        display: none;
    }
    @keyframes scanMove {
        0% { top: 20%; }
        50% { top: 80%; }
        100% { top: 20%; }
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-2">{% trans "Transport Face Recognition" %}</h2>
        <p class="text-muted">{% trans "Mark transport attendance automatically using face recognition." %}</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8 text-center">
        <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-4">
                <div class="mb-4">
                    <label class="form-label fw-bold d-block mb-3">{% trans "Select Trip Type" %}</label>
                    <div class="btn-group" role="group" style="max-width: 400px; width: 100%;">
                        <input type="radio" class="btn-check" name="trip_type" id="trip_pickup" value="PICKUP" checked>
                        <label class="btn btn-outline-primary py-2" for="trip_pickup">
                            <i class="bx bx-home-alt me-2"></i>{% trans "Pickup" %}
                        </label>

                        <input type="radio" class="btn-check" name="trip_type" id="trip_drop" value="DROP">
                        <label class="btn btn-outline-primary py-2" for="trip_drop">
                            <i class="bx bx-log-out-circle me-2"></i>{% trans "Drop" %}
                        </label>
                    </div>
                </div>

                <div class="face-preview-container mb-4">
                    <video id="face-video" class="face-preview" autoplay muted playsinline></video>
                    <canvas id="face-canvas" class="d-none"></canvas>
                    <div class="face-overlay">
                        <div class="face-guide-box"></div>
                        <div class="scan-animation" id="scanner-line"></div>
                    </div>
                </div>
                
                <div id="face-controls" class="mb-3">
                    <button type="button" class="btn btn-primary btn-lg rounded-pill px-5 shadow" id="btn-start-face">
                        <i class="bx bx-camera me-2"></i>{% trans "Start Recognition" %}
                    </button>
                    <button type="button" class="btn btn-danger btn-lg rounded-pill px-5 shadow d-none" id="btn-stop-face">
                        <i class="bx bx-stop-circle me-2"></i>{% trans "Stop Recognition" %}
                    </button>
                </div>
                
                <div id="face-status" class="fs-5 fw-medium text-muted">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                    <span class="status-text">{% trans "Camera ready" %}</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm rounded-4" id="verified-card" style="display: none;">
            <div class="card-header bg-success text-white rounded-top-4 py-3">
                <h5 class="mb-0 fw-bold">{% trans "Verified Member" %}</h5>
            </div>
            <div class="card-body text-center p-4">
                <div class="mb-3">
                    <img id="verified-photo" src="" alt="Photo" class="rounded-circle img-thumbnail shadow-sm" style="width: 140px; height: 140px; object-fit: cover;">
                </div>
                <h4 id="verified-name" class="fw-bold mb-1"></h4>
                <p id="verified-id" class="text-muted mb-3"></p>
                <div class="badge bg-success rounded-pill px-4 py-2 fs-6">
                    <i class="bx bx-check-double me-1"></i>{% trans "Attendance Marked" %}
                </div>
            </div>
        </div>
        
        <div class="mt-4" id="recent-scans">
            <h6 class="fw-bold mb-3 text-uppercase">{% trans "Recent Verifications" %}</h6>
            <div id="log-container" class="list-group shadow-sm rounded-4 overflow-hidden border-0">
                <!-- Logs here -->
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let videoStream = null;
        let recognitionInterval = null;
        const videoEl = document.getElementById('face-video');
        const canvasEl = document.getElementById('face-canvas');
        const statusSp = document.querySelector('#face-status .status-text');
        const statusSpin = document.querySelector('#face-status .spinner-border');
        const scannerLine = document.getElementById('scanner-line');
        
        const btnStart = document.getElementById('btn-start-face');
        const btnStop = document.getElementById('btn-stop-face');
        
        const vCard = document.getElementById('verified-card');
        const vPhoto = document.getElementById('verified-photo');
        const vName = document.getElementById('verified-name');
        const vId = document.getElementById('verified-id');
        const logContainer = document.getElementById('log-container');

        btnStart.addEventListener('click', async () => {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoEl.srcObject = videoStream;
                
                btnStart.classList.add('d-none');
                btnStop.classList.remove('d-none');
                scannerLine.style.display = 'block';
                
                statusSp.textContent = "{% trans 'Analyzing faces...' %}";
                statusSpin.classList.remove('d-none');
                
                recognitionInterval = setInterval(captureAndVerify, 3000); 
                
            } catch (err) {
                alert("{% trans 'Could not access camera. Please check permissions.' %}");
                console.error(err);
            }
        });

        btnStop.addEventListener('click', stopFaceRec);

        function stopFaceRec() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoEl.srcObject = null;
                videoStream = null;
            }
            if (recognitionInterval) {
                clearInterval(recognitionInterval);
                recognitionInterval = null;
            }
            btnStart.classList.remove('d-none');
            btnStop.classList.add('d-none');
            scannerLine.style.display = 'none';
            statusSp.textContent = "{% trans 'Camera stopped' %}";
            statusSpin.classList.add('d-none');
        }

        async function captureAndVerify() {
            if (!videoStream) return;
            
            // Capture frame from video
            const context = canvasEl.getContext('2d');
            canvasEl.width = videoEl.videoWidth;
            canvasEl.height = videoEl.videoHeight;
            context.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
            
            const imageData = canvasEl.toDataURL('image/jpeg', 0.8);
            const tripType = document.querySelector('input[name="trip_type"]:checked').value;

            try {
                const response = await fetch('{% url "transportation:api_verify_face" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        image: imageData,
                        trip_type: tripType
                    })
                });
                
                const data = await response.json();
                
                if (data.match) {
                    showVerified(data);
                    addLog(data);
                    // Pause briefly after successful match?
                } else if (data.error) {
                    statusSp.textContent = data.error;
                } else {
                    statusSp.textContent = data.message || "{% trans 'Looking for matches...' %}";
                }
            } catch (err) {
                console.error("API Error:", err);
            }
        }

        function showVerified(data) {
            vCard.style.display = 'block';
            vName.textContent = data.name;
            vId.textContent = data.admission_number;
            vPhoto.src = data.image_url || '{% static "assets/images/avatars/avatar-1.png" %}';
            
            vCard.classList.remove('animate__fadeIn');
            void vCard.offsetWidth; // Trigger reflow
            vCard.classList.add('animate__fadeIn');
        }

        function addLog(data) {
            const time = new Date().toLocaleTimeString();
            const logItem = `
                <div class="list-group-item list-group-item-action d-flex align-items-center p-3 border-0 border-bottom">
                    <div class="me-3">
                        <img src="${data.image_url || '{% static "assets/images/avatars/avatar-1.png" %}'}" class="rounded-circle" width="40" height="40">
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold fs-6">${data.name}</div>
                        <small class="text-muted">${data.admission_number} â€¢ ${time}</small>
                    </div>
                </div>
            `;
            logContainer.insertAdjacentHTML('afterbegin', logItem);
        }
    });
</script>
{% endblock %}
