{% extends "layouts/dashboard.html" %}

{% block title %}QR Attendance{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <!-- Scanner Column -->
    <div class="col-md-5">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-primary text-white text-center py-3">
                <h4 class="mb-0"><i class="bx bx-qr-scan me-2"></i> Attendance Scanner</h4>
            </div>
            <div class="card-body p-4 text-center">
                <div class="mb-3">
                    <div id="reader" style="width: 100%; border-radius: 10px; overflow: hidden;"></div>
                </div>
                <p class="text-muted"><i class="bx bx-info-circle"></i> Point the camera at a Student ID Card</p>
                
                <div id="scan-status" class="alert alert-secondary d-none">
                    Scanning...
                </div>
            </div>
        </div>
    </div>

    <!-- Result Column -->
    <div class="col-md-5">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-success text-white text-center py-3">
                <h4 class="mb-0"><i class="bx bx-check-circle me-2"></i> Last Scanned</h4>
            </div>
            <div class="card-body d-flex flex-column justify-content-center align-items-center" id="result-container">
                <!-- Default Placeholder -->
                <div class="text-center text-muted opacity-50">
                    <i class="bx bx-id-card" style="font-size: 5rem;"></i>
                    <p class="mt-2">No student scanned yet.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const beepSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 
    // Or use a local asset if available. This is a generic beep.

    let isScanning = true;

    function onScanSuccess(decodedText, decodedResult) {
        if (!isScanning) return;

        // Prevent rapid double scans
        isScanning = false;
        
        // Visual feedback
        document.getElementById('scan-status').classList.remove('d-none');
        document.getElementById('scan-status').innerText = "Processing...";
        
        // Play beep
        beepSound.play().catch(e => console.log("Audio play failed", e));

        console.log(`Scanned: ${decodedText}`);

        // Call API
        fetch("{% url 'attendance:mark_qr_submit' %}", {
            // My apps/attendance/urls.py does NOT include api urls under 'attendance' namespace usually.
            // Config/api_urls.py includes them under /api/attendance/.
            // So URL reversing might need 'attendance-api:api-mark-qr' OR I should hardcode '/api/attendance/mark-qr/'.
            // I'll check config/api_urls.py namespace. usually it is None or 'api'.
            // I will use hardcoded path '/api/attendance/mark-qr/' or try to reverse if I knew namespace.
            // Let's use fetch('/api/attendance/mark-qr/') for safety given standardized API structure.
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ qr_text: decodedText })
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(res => {
            if (res.status === 200) {
                showSuccess(res.body);
            } else {
                showError(res.body.error || "Unknown Error");
            }
        })
        .catch(err => {
            showError("Network Error");
        })
        .finally(() => {
            // Resume scanning after delay
            setTimeout(() => {
                 isScanning = true;
                 document.getElementById('scan-status').classList.add('d-none');
            }, 3000);
        });
    }

    function showSuccess(data) {
        const container = document.getElementById('result-container');
        const student = data.student;
        
        // Update Side Panel
        container.innerHTML = `
            <div class="text-center animate__animated animate__fadeIn">
                <div class="mb-3">
                    ${student.photo_url 
                        ? `<img src="${student.photo_url}" class="rounded-circle border border-3 border-success" width="120" height="120">`
                        : `<div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto border border-3 border-success" style="width: 120px; height: 120px;"><i class="bx bx-user fs-1 text-secondary"></i></div>`
                    }
                </div>
                <h3 class="text-success fw-bold">${student.name}</h3>
                <h5 class="text-dark">${student.class}</h5>
                <p class="text-muted mb-1">Adm No: ${student.admission_number}</p>
                <div class="alert alert-success mt-3 mb-0">
                    <i class="bx bx-check-circle"></i> ${data.message}
                </div>
            </div>
        `;

        // SweetAlert Toast
        Swal.fire({
            icon: 'success',
            title: 'Attendance Marked',
            text: `${student.name} (${student.admission_number})`,
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
        });
    }

    function showError(msg) {
        // Update Side Panel ?? Maybe keep last success.
        // Just show Alert.
        Swal.fire({
            icon: 'error',
            title: 'Scan Failed',
            text: msg,
            timer: 3000,
            showConfirmButton: false
        });
    }

    function onScanFailure(error) {
        // ignore
    }

    let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        { fps: 10, qrbox: {width: 250, height: 250} },
        /* verbose= */ false
    );
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
</script>
</script>

<style>
    /* Styling for html5-qrcode generated buttons */
    #reader button {
        display: inline-block;
        font-weight: 600;
        text-align: center;
        text-decoration: none;
        vertical-align: middle;
        cursor: pointer;
        user-select: none;
        background-color: #0d6efd;
        border: 1px solid #0d6efd;
        color: #fff;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        border-radius: 0.25rem;
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out;
        margin: 5px;
    }

    #reader button:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }
    
    #reader__dashboard_section_swaplink {
        display: none !important; /* Hide the 'scan image file' link if desired, or style it too */
    }
    
    #reader__dashboard_section_csr span {
        display: none; /* Hide 'Request Camera Permissions' text sometimes shown */
    }
</style>
{% endblock %}
