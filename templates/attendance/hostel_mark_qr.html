{% extends "layouts/dashboard.html" %}

{% block title %}Hostel QR Attendance{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <!-- Scanner Column -->
    <div class="col-md-5">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-primary text-white text-center py-3">
                <h4 class="mb-0"><i class="bx bx-qr-scan me-2"></i> Hostel Attendance Scanner</h4>
            </div>
            <div class="card-body p-4 text-center">
                <div class="mb-3">
                    <div id="reader" style="width: 100%; border-radius: 10px; overflow: hidden;"></div>
                </div>
                <p class="text-muted"><i class="bx bx-info-circle"></i> Point the camera at a Student ID Card</p>
                
                <div id="scan-status" class="alert alert-secondary d-none">
                    Scanning...
                </div>
            </div>
        </div>
    </div>

    <!-- Result Column -->
    <div class="col-md-5">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-success text-white text-center py-3">
                <h4 class="mb-0"><i class="bx bx-check-circle me-2"></i> Last Scanned</h4>
            </div>
            <div class="card-body d-flex flex-column justify-content-center align-items-center" id="result-container">
                <!-- Default Placeholder -->
                <div class="text-center text-muted opacity-50">
                    <i class="bx bx-home-heart" style="font-size: 5rem;"></i>
                    <p class="mt-2">No student scanned yet.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const beepSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 

    let html5QrCode;
    let lastScannedCode = null;
    let scanCooldown = false;

    function onScanSuccess(decodedText, decodedResult) {
        if (scanCooldown || decodedText === lastScannedCode) {
            return;
        }

        lastScannedCode = decodedText;
        scanCooldown = true;
        
        beepSound.play().catch(e => console.log('Audio play failed:', e));

        // Send to backend with type='hostel'
        fetch("{% url 'attendance:mark_qr_submit' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                qr_text: decodedText,
                type: 'hostel'  // Hostel attendance type
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                // Mark hostel attendance separately
                markHostelAttendance(data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Network error. Please try again.');
        })
        .finally(() => {
            setTimeout(() => {
                scanCooldown = false;
                lastScannedCode = null;
            }, 2000);
        });
    }

    function markHostelAttendance(studentData) {
        // You can add additional hostel-specific logic here
        showSuccess(studentData);
    }

    function showSuccess(data) {
        const resultContainer = document.getElementById('result-container');
        resultContainer.innerHTML = `
            <div class="text-center animate__animated animate__fadeIn">
                ${data.photo_url ? 
                    `<img src="${data.photo_url}" alt="Student Photo" class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover; border: 4px solid #28a745;">` 
                    : 
                    `<i class="bx bx-user-circle text-success" style="font-size: 120px;"></i>`
                }
                <h4 class="text-success mb-2"><i class="bx bx-check-circle"></i> Hostel Attendance Marked</h4>
                <h5 class="mb-1">${data.student_name || 'Student'}</h5>
                <p class="text-muted mb-0"><i class="bx bx-time"></i> ${new Date().toLocaleTimeString()}</p>
            </div>
        `;

        Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: 'Hostel attendance marked successfully',
            timer: 2000,
            showConfirmButton: false
        });
    }

    function showError(message) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: message,
            confirmButtonColor: '#d33'
        });
    }

    // Initialize Scanner
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess
    ).catch(err => {
        console.error("Unable to start scanner:", err);
        document.getElementById('scan-status').innerHTML = 
            '<span class="text-danger"><i class="bx bx-error"></i> Camera access denied or unavailable</span>';
        document.getElementById('scan-status').classList.remove('d-none');
    });

    // Custom button styles
    const style = document.createElement('style');
    style.textContent = `
        #reader__scan_region button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: none !important;
            padding: 10px 20px !important;
            border-radius: 8px !important;
            font-weight: 500 !important;
            transition: all 0.3s ease !important;
        }
        #reader__scan_region button:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4) !important;
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
