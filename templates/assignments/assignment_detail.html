{% extends 'layouts/dashboard.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{{ assignment.title }}{% endblock %}

{% block content %}

    {% include 'partials/breadcrumb.html' with page_title=assignment.title current_text=_("Detail") parent_text=_("Assignments") parent_url="assignments:assignment_list" %}

    <div class="row">
        <!-- Assignment Details -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h4 class="card-title">{{ assignment.title }}</h4>
                        <span class="badge {% if assignment.status == 'PUBLISHED' %}bg-success-subtle text-success{% else %}bg-secondary-subtle text-secondary{% endif %}">
                            {{ assignment.get_status_display }}
                        </span>
                    </div>
                    
                    <div class="mb-4 text-muted">
                        <span class="me-3"><i class="bx bx-book me-1"></i> {{ assignment.subject.name }} ({{ assignment.class_name.name }})</span>
                        <span class="me-3"><i class="bx bx-calendar me-1"></i> Due: {{ assignment.due_date|date:"d M Y" }}</span>
                        <span><i class="bx bx-star me-1"></i> Marks: {{ assignment.max_marks }}</span>
                    </div>

                    <div class="mb-4">
                        <h6>{% trans "Description" %}</h6>
                        <p>{{ assignment.description|linebreaks }}</p>
                    </div>

                    {% if assignment.attachment %}
                        <div class="mb-4">
                            <h6>{% trans "Attachment" %}</h6>
                            <a href="{{ assignment.attachment.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                <i class="bx bx-download me-1"></i> {% trans "Download Attachment" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Student Submission Section -->
            {% if user.role == 'student' %}
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">{% trans "Your Submission" %}</h5>
                    </div>
                    <div class="card-body p-4">
                        {% if submission %}
                            <div class="alert {% if submission.status == 'SUBMITTED' %}alert-info{% elif submission.status == 'GRADED' %}alert-success{% else %}alert-secondary{% endif %}">
                                <strong>{% trans "Status" %}:</strong> {{ submission.get_status_display }}
                                <br>
                                <strong>{% trans "Submitted on" %}:</strong> {{ submission.submitted_at|date:"d M Y, H:i" }}
                            </div>
                            
                            {% if submission.marks_obtained %}
                                <div class="mb-3">
                                    <strong>{% trans "Marks Obtained" %}:</strong> {{ submission.marks_obtained }} / {{ assignment.max_marks }}
                                </div>
                            {% endif %}
                            
                            {% if submission.teacher_remarks %}
                                <div class="mb-3">
                                    <strong>{% trans "Teacher Remarks" %}:</strong>
                                    <p class="mb-0">{{ submission.teacher_remarks }}</p>
                                </div>
                            {% endif %}
                            
                            {% if submission.submission_file %}
                                <div>
                                    <a href="{{ submission.submission_file.url }}" class="btn btn-sm btn-outline-primary">{% trans "View Your File" %}</a>
                                </div>
                            {% endif %}
                            
                            <div class="mt-3">
                                <h6>{% trans "Your Answer" %}</h6>
                                <p>{{ submission.submission_text|linebreaks }}</p>
                            </div>
                        {% else %}
                            <form action="{% url 'assignments:submission_create' assignment.pk %}" method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                {{ submission_form|crispy }}
                                <button type="submit" class="btn btn-primary mt-3">{% trans "Submit Assignment" %}</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Teacher Sidebar / Submission List -->
        {% if user.role == 'teacher' or user.role == 'admin' %}
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">{% trans "Submissions" %}</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for sub in submissions %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <h6 class="mb-0">{{ sub.student.full_name }}</h6>
                                    <small class="text-muted">{{ sub.submitted_at|date:"d M" }}</small>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-light text-dark border">{{ sub.get_status_display }}</span>
                                    {% if sub.marks_obtained %}
                                        <span class="fw-bold text-success">{{ sub.marks_obtained }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                                <!-- Future: Add grading link/modal here -->
                            </div>
                        {% empty %}
                            <div class="p-3 text-center text-muted">
                                {% trans "No submissions yet" %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

{% endblock %}
